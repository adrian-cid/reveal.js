<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>AJAX Callback Commands - NYCCAMP 2015</title>

		<meta name="description" content="Demystifying Drupal AJAX Callback Commands">
		<meta name="author" content="Michael Miles">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/nyccamp-color.css" id="theme">
		<link rel="stylesheet" href="css/nyccamp.css">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">
            <div class="footer">
                <div class="branding--logo">
                    <span class="logo__image"><img src="lib/image/content/logo.png" alt="Drupal NYC camp 2015 logo" height="55px" /></span>
                    <p class="logo__site-name">#NYCcamp</p>
                </div>
                <div class="company--logo">
                    <span class="logo__image"><img src="lib/image/content/gi-logo-nyccamp.png" alt="Genuine Interactive" height="40px" width="40px" /></span>
                    <p class="logo__site-name">@WeAreGenuine</p>
                </div>
                <div class="session--info">
                    <p class="session__title">
                    	AJAX Callback Commands<span class="seperator">&nbsp;/&nbsp;</span>
                    </p>
                    <p class="session__presenter">@mikemiles86</p>
                </div>
            </div>

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<!-- INTRO -->
        <section>
          <section data-transition="convex">
              <h1>Demystifying Drupal <br />AJAX Callback Commands</h1>
              <h2><a href="http://nyccamp.org/node/287/edit" target="_blank">http://nyccamp.org/node/287</a></h2>
              <h3>NYC CAMP 2015</h3>
              <h4>#NYCcamp</h4>
              <aside class="notes"></aside>
          </section>
            <section data-transition="convex">
              <h1>Goals of this Session</h1>
              <p>
                  <ul>
                    <li class="fragment step-note">Explain what AJAX callback commands are</li>
                    <li class="fragment step-note">Demonstrate how to use AJAX callback commands</li>
                    <li class="fragment step-note">Outline how to create AJAX callback commands</li>
                  </ul>
              </p>
            </section>
            <section data-transition="convex">
              <h1>Michael Miles</h1>
              <p class="fragment">
                <strong>From: </strong>Boston, MA USA
              </p>
              <p class="fragment">
                <strong>Work: </strong>
                <a href="http://wearegenuine.com" target="_blank">Genuine</a>
                  <span style="font-size:70%"> @WeAreGenuine(.com)</span>
              </p>
              <p class="fragment">
                <strong>Exp:</strong> Working with Drupal since 2008.<br />
              </p>
              <p>
                <span class="fragment step-note">Acquia Certified.</span>
                <span class="fragment step-note">2014 Acquia MVP.</span>
              </p>
              <br />
              <p>
                <span class="fragment"><strong>Twitter:</strong> @mikemiles86</span>
                <span class="fragment"><strong>Drupal.org:</strong> mikemiles86</span>
                <br />
                <span class="fragment"><strong>All the Places:</strong> mikemiles86</span>
              </p>
              <aside class="notes">
                <ul>
                  <li>Genuine - full service digital agency</li>
                  <li>Specialize in Brand engagments, SEO, UX, Design, Video, Development</li>
                  <li>Home Office in Boston. Offices in NYC, SF, Chicago</li>
                </ul>
              </aside>
          </section>
          <section data-transition="convex">
            <h1>Warning About Example Code</h1>
            <ul>
              <li class="fragment step-note">There is example code</li>
              <li class="fragment step-note">Some coding standards ignored for presentation purposes</li>
              <li class="fragment step-note">Drupal 8 code still subject to change</li>
            </ul>
            <img class="fragment" data-src="images/will-ferrell-wine.gif" alt="Will Ferrell: wine in a recliner." />
          </section>
        </section>
        <section>
          <section data-transition="convex">
            <h1>What Commands Are</h1>
            <img class="section-gif" data-src="images/what-the-what.gif" alt="30 Rock: What the what?" />
            <aside class="notes">
              Explain what AJAX Callback commands are from a high level and how Drupal uses them.
              Explain what an AJAX Callback command is on the Client Side and on the Server Side.
            </aside>
          </section>
          <section data-transition="convex">
            <h2>From a High Level</h2>
            <ul>
              <li class="fragment step-note">The response of AJAX request</li>
              <li class="fragment step-note">PHP code to instruct JavaScript functions</li>
              <li class="fragment step-note">A JavaScript function attached to an object</li>
              <li class="fragment step-note">Defined by Drupal core or modules
                <ul>
                  <li class="fragment step-note">17 AJAX callback commands in Drupal 7</li>
                </ul>
              </li>
            </ul>
            <aside class="notes">
              What are returned by an AJAX request from AJAX Framework.
              Framework replaced AHAH.
              A Global JS object provided by Drupal.
              An extendable system, like most of Drupal.
            </aside>
          </section>
          <section data-transition="convex">
            <h2>Example: The "Remove" Command</h2>
            <img class="section-gif" data-src="images/ajax-commands-remove-example.gif" alt="Using the 'examples' module (available on Drupal.org), showing using the 'remove' AJAX Callback command. The checkbox is checked, which makes an AJAX request, which returns the command to remove the element with the sample text." />
            <p class="caption">
              Using the "examples" module (available on Drupal.org), showing using the 'remove' AJAX Callback command. The checkbox is checked, which makes an AJAX request, which returns the command to remove the element with the sample text.
            </p>
          </section>
          <section data-transition="convex">
            <h2>On the Client Side [D7]</h2>
            <ul>
              <li class="fragment step-note">A function on the 'Drupal.ajax.prototype.commands' object
                <ul>
                  <li class="fragment step-note">Receives 'ajax', 'response' and 'status' arguments</li>
                </ul>
              </li>
              <li class="fragment step-note">A wrapper for additional javascript</li>
            </ul>
            <pre class="fragment"><code class="js" data-trim data-line-numbers=true>
// Provide a series of commands that the server can request the client perform.
Drupal.ajax.prototype.commands = {
    //...
    /**
     * Command to remove a chunk from the page.
     */
    remove: function (ajax, response, status) {
      var settings = response.settings || ajax.settings || Drupal.settings;
      Drupal.detachBehaviors($(response.selector), settings);
      $(response.selector).remove();
    },
    //...
}
            </code><span class="codename">misc/ajax.js </span></pre>
            <aside class="notes">
              ajax : triggering element, callback made, DOM element attached to.
              response: Data returned from the request
              status: the status code of the response.
            </aside>
          </section>
          <section data-transition="convex">
            <h2>On the Server Side [D7]</h2>
            <ul>
              <li class="fragment step-note">A PHP function which returns an associative array
                <ul>
                  <li class="fragment step-note">Array must have an element with key of 'command'</li>
                  <li class="fragment step-note">The value is the name of a JavaScript function</li>
                  <li class="fragment step-note">Additional array elements set as response data</li>
                </ul>
              </li>
            </ul>
            <pre class="fragment"><code class="php" data-trim data-line-numbers=true>
/**
 * Creates a Drupal Ajax 'remove' command.
 */
function ajax_command_remove($selector) {
  return array(
    'command' => 'remove',
    'selector' => $selector,
  );
}
            </code><span class="codename">includes/ajax.inc </span></pre>
          </section>
          <section data-transition="convex">
            <img data-src="images/liz-lemon-high-five.gif" alt="30 Rock: Liz Lemon high five." class="section-gif"  />
          </section>
        </section>
         <section>
          <section data-transition="convex">
            <h1>How to Use Commands</h1>
            <img data-src="images/doctor-who-how.gif" alt="Doctor Who: How?" class="section-gif" />
            <aside class="notes">
              Exmaple scenario for using AJAX Callback Commands.
              Go through the proccess of implmeneting the use of AJAX Callback Commands.
            </aside>
          </section>
          <section data-transition="convex">
            <h2>Example Scenario</h2>
            <pre><code class="gherkin" data-trim data-line-numbers=true>
 &nbsp;As a user
 When I navigate to the 'my-messages' page
 Then I see a list of my unread messages
 And I see a list of my read messages

 When I click on an unread message
 Then the full messaged is retrieved from the server
 And I see the content of my message
 And the message is removed from the unread messages list
And the message is added to the read messages list</code></pre>
          </section>
          <section data-transition="convex">
            <img data-src="images/ajax-commands-example.gif" class="screenshot" alt="Example Scenario. Have a page that lists messages to read. When a message subject is clicked, an AJAX request is made to retrieve the message. The server returns an array of commands to run, which updates the page with the selected message." />
          <p class="caption">
            Example Scenario. Have a page that lists messages to read. When a message subject is clicked, an AJAX request is made to retrieve the message. The server returns an array of commands to run, which updates the page with the selected message.
          </p>
          </section>
          <section data-transition="convex">
              <h2>To Use Commands...</h2>
              <ol>
                <li class="fragment step-note">Include Drupal AJAX JavaScript library</li>
                <li class="fragment step-note">Attach AJAX to page elements</li>
                <li class="fragment step-note">
                  Define a callback path and function
                  <ul>
                    <li class="fragment step-note">Returns a render array of commands [D7]</li>
                  </ul>
                </li>
              </ol>
              <aside class="notes">
                3 steps<br />
                <ol>
                  <li>Include AJAX library</li>
                  <li>Add AJAX to an element</li>
                  <li>Define callback, which returns render array</li>
                </ol>
              </aside>
          </section>
          <section data-transition="convex">
            <h3 class="step-note">1. Include Drupal AJAX library</h3>
            <pre><code data-trim data-line-numbers=true>
// Render a page of messages.
function mymodule_messages_page() {
  // Include AJAX library.
  drupal_add_library('system', 'drupal.ajax');
  // Create inital page content.
  $content = theme_item_list(array(
    'title' => t('Unread Messages'),
    'type' => 'ul',
    'attributes' => array( 'id' => 'unread-msgs'),
   'items' => mymodule_messages_list(mymodule_get_unread_messages()),
  ));
  $content .= '<div id="current-msg"><h2></h2><p></p></div>';
  $content .= theme_item_list(array(
    'title' => t('Read Messages'),
    'type' => 'ul',
    'attributes' => array('id' => 'read-msgs'),
    'items' => mymodule_messages_list(mymodule_get_read_messages(), FALSE),
  ));

  return $content;
}
            </code><span class="codename">mymodule/mymodule.module </span></pre>
            <p class="caption">Function to build a page of messages. On line #4, using the drupal_add_librry() function to include the AJAX library on the page.</p>
          </section>
          <section data-transition="convex">
            <h3 class="step-note">2. Attach AJAX to page elements</h3>
            <pre><code data-trim data-line-numbers=true>
// Return array of message titles for use in a list.
function mymodule_messages_list($messages, $display_link = TRUE) {
  $list_items = array();
  foreach ($messages as $mid => $msg) {
    // Build link to AJAX callback to load message.
    $link = l($msg->subject, 'read-message-callback/nojs/' . $mid, array(
      // Add class to link so Drupal knows to use AJAX.
      'attributes' => array('class' => array('use-ajax')),
    ));
    // Create list item for message.
    $list_items[] = array(
      'id' => 'msg-' . $mid,
      // Set data to read message link or just message subject.
      'data' => $display_link ? $link : $msg->subject,
    );
  }
  return $list_items;
}
            </code><span class="codename">mymodule/mymodule.module </span></pre>
            <p class="caption">Function to build a list of messages. On line #6, creating a link element which links to our callback path. On line #8, adding the class 'use-ajax' so AJAX framework knows to serve link with an AJAX request.</p>
          </section>
          <section data-transition="convex">
            <h3 class="step-note">3.a Define a callback path</h3>
            <pre><code data-trim data-line-numbers=true>
// Implements hook_menu().
function mymodule_menu() {
  $items = array();
  //.. Other menu items.
  // None JS callback, for graceful degredation.
  $items['read-message-callback/nojs/%'] = array(
    'title' => 'AJAX Callback to Read Message',
    'access arguments' => array('access content'),
    'page callback' => 'mymodule_read_message_callback',
    'page arguments' => array(1,2),
    'type' => MENU_CALLBACK,
  );
  // Create AJAX callback. Add ajax_delivery callback.
  $items['read-message-callback/ajax/%'] = array(
    'delivery callback' => 'ajax_deliver',
  ) + $items['read-message-callback/nojs/%'];

  return $items;
}
            </code><span class="codename">mymodule/mymodule.module </span></pre>
            <p class="caption">Creating two menu items for callback functions. The first is for handling graceful degredation when reached outside an AJAX Request. The second is the AJAX callback, which add a delivery callback of "ajax_callback" so Drupal know to return an AJAX Response object.</p>
          </section>
          <section data-transition="convex">
            <h3 class="step-note">
              3.b Return array of commands using a render array [D7]
            </h3>
            <pre><code data-trim data-line-numbers=true>
// AJAX Callback to read a message.
function mymodule_read_message_callback($method, $mid) {
  $message = mymodule_load_message($mid);
  // @TODO: Graceful degredation if not from ajax method or if no message.
  $commands = array(
    // Replace content of current message subject.
    ajax_command_html('#current-msg h2', $message->subject),
    // Replace content of current message body.
    ajax_command_html('#current-msg p', $message->content),
   // Remove message from unread list.
   ajax_command_remove('#msg-' . $mid),
   // Add message to read list
   ajax_command_append('#read-msgs', '<li>' . $message->subject . '</li>'),
 );
 // Return an AJAX render array.
 return array(
   '#type' => 'ajax',
   '#commands' => $commands,
 );
}
            </code><span class="codename">mymodule/mymodule.module </span></pre>
             <p class="caption">Lines #5 thru #14, building an array of Core AJAX Callback commands. Each mapps to a javascript function. Line #16 building a render array of type 'ajax'. Drupal will package into JSON and send back to the client.</p>
          </section>
          <section data-transition="convex">
            <img data-src="images/doctor-who-brilliant.gif" alt="Doctor Who: Brilliant!" class="section-gif" />
          </section>
        </section>
        <section>
          <section data-transition="convex">
            <h1>Creating Custom Commands</h1>
            <img data-src="images/jane-thrilling-heroics.gif" alt="Firefly: time for some thrilling heroics" />
          </section>
          <section data-transition="convex">
            <h2>To Create a Command...</h2>
            <ol>
              <li class="fragment step-note">Add a function to the Drupal ajax command JavaScript object</li>
              <li class="fragment step-note">
                Write PHP code that returns an associative array.
                <ul>
                  <li class="fragment step-note">Must have an element with key of 'command'</li>
                  <li class="fragment step-note">Value is name of the JavaScript function</li>
                  <li class="fragment step-note">Additional elements for response data</li>
              </li>
            </ol>
            <aside class="notes">
              2 steps<br />
              <ol>
                <li>Add JS function to JS object.</li>
                <li>PHP code returns an associative array.</li>
              </ol>
            </aside>
          </section>
          <section data-transition="convex">
            <p>That's it.</p>
            <img data-src="images/mal-speechless.gif" alt="Firefly: Mal Speechless." class="section-gif" />
          </section>
          <section data-transition="convex">
            <h2>A Custom Command in Drupal 7</h2>
            <ol>
              <li class="fragment step-note">Add a function to 'Drupal.ajax.prototype.commands'</li>
              <li class="fragment step-note">Define a PHP function to return an array</li>
            </ol>
            <aside class="notes">
              2 steps<br />
              <ol>
                <li>Add JS function to JS object.</li>
                <li>PHP function returns an associative array.</li>
              </ol>
            </aside>
          </section>
          <section data-transition="convex">
            <h3 class="step-note">1. Add a function to 'Drupal.ajax.prototype.commands'</h3>
            <pre><code class="js" data-trim data-line-numbers=true>
(function($, Drupal) {
 // Add new command for reading a message.
 Drupal.ajax.prototype.commands.readMessage = function(ajax, response, status){
    // Place content in current-msg div.
    $('#current-msg h2').html(response.subject);
    $('#current-msg p').html(response.content);
    // Remove from unread list.
    $('#msg-' + response.mid).remove();
    // Add message to read list.
    $('#read-msgs').append('<li>' + response.subject + '</li>');
  }
})(jQuery, Drupal);
            </code><span class="codename">mymodule/js/commands.js </span></pre>
            <p class="caption">Attach a new 'readMessage' command to the Drupal AJAX Commands JavaScript object. Function takes in the 3 arguments "ajax", "response" & "status". Wraps jQuery functions to display a message on the page.</p>
          </section>
          <section data-transition="convex">
            <h3 class="step-note">2. Define a PHP function to return an associative array</h3>
            <pre><code class="php" data-trim data-line-numbers=true>
/**
 * AJAX command to read a message.
 */
function mymodule_command_read_message($message) {
  return array(
    'command' => 'readMessage',
    'mid' => $message->mid,
    'subject' => $message->subject,
    'content' => $message->content,
  );
}
            </code><span class="codename">mymodule/mymodule.module </span></pre>
             <p class="caption">PHP function that mapps to the new JavaScript 'readMessage' array. Returns an associative array, with an element that has a key of 'command' and value of the JavaScript function name 'readMessage'. Then additional elements to be sent as request data.</p>
          </section>
          <section data-transition="convex">
            <h2>Using a custom command...</h2>
            <ol>
              <li class="fragment step-note">Tell Drupal to include custom JavaScript</li>
              <li class="fragment step-note">Return custom command in callback function</li>
            </ol>
            <aside class="notes">
              2 steps<br />
              <ol>
                <li>Include custom JS.</li>
                <li>Return command in callback.</li>
              </ol>
            </aside>
          </section>
          <section>
            <p>Again...that's it.</p>
            <img data-src="images/mal-speechless.gif" alt="Firefly: Mal Speechless." class="section-gif" />
          </section>
          <section data-transition="convex">
            <h2>Using a Custom Command in Drupal 7</h2>
            <ol>
              <li class="fragment step-note">Use drupal_add_js() to include custom JavaScript on page</li>
              <li class="fragment step-note">Add command to render array returned by callback</li>
            </ol>
          </section>
          <section>
            <h3 class="step-note">1. Use drupal_add_js() to include custom JavaScript on page</h3>
            <pre><code class="php" data-trim data-line-numbers=true>
// Render a page of my messages
function mymodule_messages_page() {
  // Include AJAX library.
  drupal_add_library('system', 'drupal.ajax');
  // Include custom JavaScript.
  drupal_add_js(drupal_get_path('module', 'mymodule') . '/js/commands.js');

  // .. Build $content.

  return $content;
}
            </code><span class="codename">mymodule/mymodule.module </span></pre>
            <p class="caption">The example function for creating the messages page. In addition to adding the Drupal AJAX library on line #4 also using drupal_add_js() to include custom javascript file on line #6.</p>
          </section>
          <section data-transition="convex">
            <h3 class="step-note">2. Add command to render array returned by callback</h3>
            <pre><code class="php" data-trim data-line-numbers=true>
// AJAX Callback to read a message.
function mymodule_read_message_callback($method, $mid) {
  $message = mymodule_load_message($mid);
  // @TODO: Graceful degredation if not from ajax method or if no message.
  $commands = array(
    // Call the readMessage javascript function.
    mymodule_command_read_message($message),
 );
 // Return an AJAX render array.
 return array(
   '#type' => 'ajax',
   '#commands' => $commands,
 );
}
            </code><span class="codename">mymodule/mymodule.module </span></pre>
            <p class="caption">The example callback function that returns an AJAX render array. Commands array on lines #5 thru #8, only returns a single command. The new custom command that was created.</p>
          </section>
          <section data-transition="convex">
            <img data-src="images/jane-cunning.gif" alt="Firefly: Jane cunning" style="section-gif" />
          </section>
        </section>
        <section>
          <section>
            <h1>AJAX Commands in Drupal 8</h1>
            <img data-src="images/sheldon-change.gif" alt="Big Bang: Fear Change." class="section-gif" />
          </section>
          <section data=transition="convex">
            <h1>Changes to AJAX Commands</h1>
            <ul>
              <li class="fragment step-note">22 AJAX callback commands in Drupal 8</li>
              <li class="fragment step-note">JavaScript attatches to 'Drupal.AjaxCommands.prototype' object</li>
              <li class="fragment step-note">A PHP object that implements CommandInterface
                <ul>
                  <li class="fragment step-note">Must implement 'render' method</li>
                </ul>
              </li>
            </ul>
          </section>
          <section data-transition="convex">
            <h2>Example: The "Remove" Command</h2>
            <img class="section-gif" data-src="images/ajax-commands-remove-example.gif" alt="Using the 'examples' module (available on Drupal.org), showing using the 'remove' AJAX Callback command. The checkbox is checked, which makes an AJAX request, which returns the command to remove the element with the sample text." />
            <p class="caption">
              Using the "examples" module (available on Drupal.org), showing using the 'remove' AJAX Callback command. The checkbox is checked, which makes an AJAX request, which returns the command to remove the element with the sample text.
            </p>
          </section>
          <section data-transition="convex">
            <h2 class="step-note">A function on the 'Drupal.AjaxCommands.prototype' object</h2>
            <pre class="fragment"><code class="js" data-trim data-line-numbers=true>
/**
 * Provide a series of commands that the client will perform.
 */
Drupal.AjaxCommands.prototype = {
  //...
  /**
   * Command to remove a chunk from the page.
   */
  remove: function (ajax, response, status) {
    var settings = response.settings || ajax.settings || drupalSettings;
    $(response.selector).each(function () {
      Drupal.detachBehaviors(this, settings);
    }).remove();
  },
  //...
}
            </code><span class="codename">misc/ajax.js </span></pre>
          </section>
          <section data-transition="convex">
            <h2 class="step-note">An object that implements CommandInterface</h2>
            <p class="fragment step-note">Must implement 'render' method</p>
            </ul>
            <pre class="fragment"><code class="php" data-trim data-line-numbers=true>
namespace Drupal\Core\Ajax;
use Drupal\Core\Ajax\CommandInterface;
// AJAX command for calling the jQuery remove() method.
class RemoveCommand Implements CommandInterface {
  protected $selector;
  // Constructs a RemoveCommand object.
  public function __construct($selector) {
    $this->selector = $selector;
  }
  // Implements Drupal\Core\Ajax\CommandInterface:render().
  public function render() {
    return array(
      'command' => 'remove',
      'selector' => $this->selector,
    );
  }
}
            </code><span class="codename">core/lib/Drupal/Core/Ajax/RemoveCommand.php </span></pre>
          </section>
          <section data-transition="convex">
              <h1>To Use Commands in Drupal 8</h1>
              <ol>
                <li class="fragment step-note">Include Drupal AJAX JavaScript library
                  <ul>
                    <li class="fragment step-note">Must attach to a render array</li>
                  </ul>
                </li>
                <li class="fragment step-note">Attach AJAX to page elements</li>
                <li class="fragment step-note">
                  Define a callback path and function
                  <ul>
                    <li class="fragment step-note">Returns an AjaxResponse object</li>
                  </ul>
                </li>
              </ol>
              <aside class="notes">
                3 steps.<br />
                <ol>
                  <li>Include AJAX JS on a render array.</li>
                  <li>Add AJAX to page elements</li>
                  <li>Define a callback function returning object</li>
                </ol>
              </aside>
          </section>
          <section data-transition="convex">
            <img data-src="images/ajax-commands-example.gif" class="screenshot" alt="Example Scenario. Have a page that lists messages to read. When a message subject is clicked, an AJAX request is made to retrieve the message. The server returns an array of commands to run, which updates the page with the selected message." />
          <p class="caption">
            Example Scenario. Have a page that lists messages to read. When a message subject is clicked, an AJAX request is made to retrieve the message. The server returns an array of commands to run, which updates the page with the selected message.
          </p>
          </section>
          <section data-transition="convex">
            <h3 class="step-note">Attach library to a render array</h3>
            <pre><code class="php" data-trim data-line-numbers=true>
// Render a page of my messages
function mymodule_messages_page() {

  // .. build $content

  // Create render array.
  $page[] = array(
    '#type' => 'markup',
    '#markup' => $content,
  );
  // Attach JavaScript library.
  $page['#attached']['library'][] = 'core/drupal.ajax';

  return \Drupal::service('renderer')->render($page);
}
            </code><span class="codename">mymodule/mymodule.module </span></pre>
            <p class="caption">Function for building messages page is now using a render array. to the '#attached', 'library' array of that render array, declaring the drupal.ajax library to be included.
            </p>
          </section>
          <section data-transition="convex">
            <h3 class="step-note">
              Callback returns commands using an AJAXResponse() [D8]
            </h3>
            <pre><code data-trim data-line-numbers=true>
// AJAX Callback to read a message.
function mymodule_read_message_callback($method, $mid) {
  $message = mymodule_load_message($mid);
  // @TODO: Graceful degredation if not from ajax method or if no message.
  // Create AJAX Response object.
  $response = new AjaxResponse();
  // Replace content of current message subject.
  $response->addCommand(new HtmlCommand('#current-msg h2', $message->subject));
  // Replace content of current message body.
 $response->addCommand(new HtmlCommand('#current-msg p', $message->content));
 // Remove message from unread list.
 $response->addCommand(new RemoveCommand('#msg-' . $mid));
 // Add message to read list.
 $item = '&lt;li>' . $message->subject . '&lt;/li>';
 $response->addCommand(new AppendCommand('#read-msgs', $item));
);
 // Return ajax response.
 return $response;
}
            </code><span class="codename">mymodule/mymodule.module </span></pre>
            <p class="caption">Returning an AjaxResponse object instead of a render array like in Drupal 7. AjaxResponse has an 'addCommand' method, which takes the argument of a command object.
            </p>
          </section>
          <section data-transition="convex">
            <h2>Custom Commands in Drupal 8</h2>
            <ol>
              <li class="fragment step-note">Add function to 'Drupal.AjaxCommands.prototype'</li>
              <li class="fragment step-note">Define a command object that implements CommandInterface</li>
            </ol>
            <aside class="notes">
              2 steps.<br />
              <ol>
                <li>Add to js object</li>
                <li>Create custom command object</li>
              </ol>
            </aside>
          </section>
          <section data-transition="convex">
            <h3 class="step-note">1. Add function to 'Drupal.AjaxCommands.prototype'</h3>
            <pre><code class="js" data-trim data-line-numbers=true>
(function($, Drupal) {
  /**
   * Add new command for reading a message.
   */
 Drupal.AjaxCommands.prototype.readMessage = function(ajax, response, status){
    // Place content in current-msg div.
    $('#current-msg h2').html(response.subject);
    $('#current-msg p').html(response.content);
    // Remove from unread list.
    $('#msg-' + response.mid).remove();
    // Add message to read list.
    $('#read-msgs').append('<li>' + response.subject + '</li>');
  }
})(jQuery, Drupal);
            </code><span class="codename">mymodule/js/commands.js </span></pre>
            <p class="caption">
              Adding the custom 'readMessage' function to the Drupal 8 JavaScript AJAX Commands object. Still takes the same three arguments as in Drupal 7.
            </p>
          </section>
          <section data-transition="convex">
            <h3 class="step-note">2. Define command object that implements CommandInterface</h3>
            <pre><code class="php" data-trim data-line-numbers=true>
namespace Drupal\mymodule\Ajax;
use Drupal\Core\Ajax\CommandInterface;

class ReadMessageCommand implements CommandInterface {
  protected $message;
  // Constructs a ReadMessageCommand object.
  public function __construct($message) {
    $this->message = $message;
  }
  // Implements Drupal\Core\Ajax\CommandInterface:render().
  public function render() {
    return array(
      'command' => 'readMessage',
      'mid' => $this->message->mid,
      'subject' => $this->message->subject,
      'content' => $this->message->content,
    );
  }
}
            </code><span class="codename">mymodule/src/Ajax/ReadMessageCommand.php </span></pre>
            <p class="caption">
              Creating a Command object which implements the CommandInterface. Must declare a 'render' method, which will return an associative array. This associative array must have an element with the key of 'command' and value of the JavaScript function to run.
            </p>
          </section>
                    <section data-transition="convex">
            <h2>Using a Custom Command in Drupal 8</h2>
            <ol>
              <li class="fragment step-note">Tell Drupal about custom JavaScript library</li>
              <li class="fragment step-note">Attach library to a render array</li>
              <li class="fragment step-note">Add command to AjaxResponse object in callback</li>
            </ol>
            <aside class="notes">
              3 steps.<br />
              <ol>
                <li>Tell Drupal about library</li>
                <li>Include library on page</li>
                <li>Include callback object in response.</li>
              </ol>
            </aside>
          </section>
          <section data-transition="convex">
            <h3 class="step-note">1. Tell Drupal about custom JavaScript library</h3>
            <pre><code class="js" data-trim data-line-numbers=true>
mymodule.commands:
  version: VERSION
  js:
    js/commands.js: {}
  dependencies:
     - core/drupal.ajax
            </code><span class="codename">mymodule/mymodule.libraries.yml </span></pre>
            <p class="caption">Must tell Drupal about custom library with a libraries.yml file. Provide an Asset library name, lists all the js files needed, and any dependencies on other libraries.</p>
          </section>
          <section data-transition="convex">
            <h3 class="step-note">2. Attach library to a render array</h3>
            <pre><code class="php" data-trim data-line-numbers=true>
// Render a page of my messages
function mymodule_messages_page() {

  // .. build $content

  // Create render array.
  $page[] = array(
    '#type' => 'markup',
    '#markup' => $content,
  );
  // Attach JavaScript library.
  $page['#attached']['library'][] = 'mymodule/mymodule.commands';

  return \Drupal::service('renderer')->render($page);
}
            </code><span class="codename">mymodule/mymodule.module </span></pre>
            <p class="caption">Function for building messages page is now using a render array. to the '#attached', 'library' array of that render array, including the custom library. No longer including the AJAX library, as Drupal will know to include it from the libraries.yml file.
            </p>
          </section>

          <section data-transition="convex">
            <h3 class="step-note">3. Add command to AjaxResponse object in callback</h3>
            <pre><code class="php" data-trim data-line-numbers=true>
// AJAX Callback to read a message.
function mymodule_read_message_callback($method, $mid) {
  $message = mymodule_load_message($mid);
  // @TODO: Graceful degredation if not from ajax method or if no message.
  // Create AJAX Response object.
  $response = new AjaxResponse();
  // Call the readMessage javascript function.
  $response->addCommand( new ReadMessageCommand($message));
 );
 // Return ajax response.
 return $response;
}
            </code><span class="codename">mymodule/mymodule.module </span></pre>
            <p class="caption">Returning an AjaxResponse object instead of adding the core commands, just adding the new custom command using the 'addCommand' method.
            </p>
          </section>
          <section data-transition="convex">
            <img data-src="images/bazinga.gif" alt="Big Bang: Bazinga." class="section-gif" />
          </section>
        </section>
        <section>
          <section>
            <h1>Let's Review</h1>
            <img data-src="images/what-the-hell-happened.gif" alt="Parks& Rec: What the hell happened?" class="section-gif" />
          </section>
          <section data-transition="convex">
            <h2>AJAX Callback Commands Are...</h2>
            <ul>
              <li class="fragment step-note">Returned by all AJAX Framework requests</li>
              <li class="fragment step-note">PHP abstraction for JavaScript functions</li>
              <li class="fragment step-note">Defined by core and modules</li>
            </ul>
          </section>
          <section data-transition="convex">
            <h2>To Use AJAX Callback Commands...</h2>
            <ul>
              <li class="fragment step-note">Include Drupal AJAX JavaScript library</li>
              <li class="fragment step-note">Attach AJAX to page elements</li>
              <li class="fragment step-note">Have server side callback return array of commands</li>
            </ul>
          </section>
          <section data-transition="convex">
            <h2>To Create AJAX Callback Commands...</h2>
            <ul>
              <li class="fragment step-note">Add function to Drupal ajax command JavaScript object.  </li>
              <li class="fragment step-note">Write PHP code to return associative array with a 'command' key</li>
            </ul>
          </section>

          <section data-transition="convex">
            <h2>To Use Custom AJAX Callback Commands...</h2>
            <ul>
              <li class="fragment step-note">Include custom JavaScript</li>
              <li class="fragment step-note">Include custom command in callback function</li>
            </ul>
          </section>
          <section data-transition="convex">
            <img data-src="images/swanson-giggles.gif" alt="Parks & Rec: Ron Swanson, giggling" class="section-gif" />
          </section>
        </section>
        <section>
          <section>
            <h1>Resources</h1>

            <p>Drupal AJAX Framework: <a href="http://bit.ly/DrupalAJAX" target="_blank">bit.ly/DrupalAJAX</a></p>
            <p>Examples Module: <a href="http://bit.ly/DrupalExMod" target="_blank">bit.ly/DrupalExMod</a></p>
            <p>Drupal 7 Commands: <a href="http://bit.ly/D7ajaxCMD" target="_blank">bit.ly/D7ajaxCMD</a></p>
            <p>Drupal 8 Commands: <a href="http://bit.ly/D8ajaxCMD" target="_blank">bit.ly/D8ajaxCMD</a></p>
            <p>This Presentation: <a href="http://bit.ly/NYCcampAJAX" target="_blank">bit.ly/NYCcampAJAX</a></p>
            <p>Presentation Slides: <a href="http://bit.ly/NYCcampAJAXSlides" target="_blank">bit.ly/NYCcampAJAXSlides</a></p>
            <p>Example Code: <a href="http://bit.ly/NYCcampAJAXEx" target="_blank">bit.ly/NYCcampAJAXEx</a></p>
          </section>
          <section>
            <h1>Send me feedback!</h1>
            <h3>@mikemiles86</h3>
            <h3>#NYCcamp</h3>
          </section>
          <section>
           <h1>Thank You!</h1>
            <p>Questions?</p>
            <img data-src="images/questions.gif" alt="Will Ferrel: Say Something!" />
          </section>
        </section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
          { src: 'lib/js/jquery-2.1.3.min.js'},
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true },
          { src: 'plugin/notes/notes.js', async: true, callback: function() {createAsides();} }
				]
			});

      Reveal.addEventListener('slidechanged', initAnimatedGifs);
      Reveal.addEventListener('ready', initAnimatedGifs);
      Reveal.addEventListener('slidechanged', addLineNumbers);

      function initAnimatedGifs(event) {
        $('.animated-gif', event.currentSlide).each(function (i, e) {
            var slide = $(e).parent('section');
            if (slide.attr("class") == 'present') {
              $(e).attr('src', $(e).attr('src'));
              //enableGif(e);
            }
        });
      }

      function addLineNumbers(event) {
        $('code.hljs', event.currentSlide).each(function(){
          if ($(this).data("line-numbers") && ($(this).html().indexOf('class="line-number') < 1)) {
            $(this).parent("pre").attr("style","border-left:32px #000 solid;");
            var code = '<span class="line-number"></span>' + $(this).html().split("\n").join("\n<span class='line-number'></span>");
            $(this).html(code);
          }
        });
      }

      function createAsides(event) {
        $('.caption').each(function (i, e) {
          var text = $(this).text();
          //$(this).replaceWith("<aside class='notes'>" + text + "</aside>");
        });
      }
		</script>

	</body>
</html>
