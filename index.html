<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Drupal 7 Ajax commands</title>

		<meta name="description" content="A brief presentation on drupal 7 ajax command hooks">
		<meta name="author" content="Mike Miles">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>Drupal 7 Ajax</h1>
					<h3>command functions</h3>
					<p>
						<small>Created by <a href="http://mike-miles.com">Mike Miles</a> / <a href="http://twitter.com/mikemiles86">@mikemiles86</a></small>
					</p>
				</section>

				<section>
					<section>
						<h2>AJAX Command Functions</h2>
						<ul>
							<li class="fragment">Functions used with ajax callbacks.</li>
							<li class="fragment">For returning a richer set of data.</li>
							<li class="fragment">Part of the Drupal AJAX framework.</li>
						</ul>
					</section>
					<section>
						<h2>Return richer data? Like what?</h2>

							<p class="fragment">
								Inserting HTML<br />
								<pre class="fragment"><code class="php" data-trim>
ajax_command_html('#my-div', '&lt;p>...&lt;/p>'');
									</code></pre>
							</p>
							<p class="fragment">
								Adding CSS<br />
								<pre class="fragment"><code class="php" data-trim>
ajax_command_add_css('#my-div', 'background:#000;');
									</code></pre>
							</p>
							<p class="fragment">
								Invoking JS<br />
								<pre class="fragment"><code class="php" data-trim>
ajax_command_invoke(NULL, 'myJSFunction');
									</code></pre>
							</p>
							<p class="fragment">
								Full list: <a href="http://bit.ly/D7ajaxCMD" target="_blank">http://bit.ly/D7ajaxCMD</a>
							</p>

					</section>
				</section>
				<section>
					<h2>Supersize your callbacks!</h2>
					<section>
						<ul>
							<li class="fragment">Return multiple commands.</li>
							<li class="fragment">Change multiple elements on a page.</li>
							<li class="fragment">Trigger multiple events.</li>
						</ul>
					</section>
					<section>
						<p>Use a render array<br />
						<pre style="font-size:40%;"><code class="php" data-trim>/**
 * Custom AJAX callback.
 */
function my_module_ajax_callback($id) {
  // Get news article based on id.
  $article = my_module_get_news_article($id);
  // Return AJAX render array of commands.
  return array(
    '#type' => 'ajax',
    '#commands' => array(
      // Insert news article.
      ajax_command_insert('#news', drupal_render($article)),
      // Add news article to news list.
      ajax_command_append('#news-list', '&lt;li>' . $article->title . '&lt;/li>'),
      // Restripe news lists.
      ajax_command_restripe('#news-list'),
      // Invoke JS function to highlight new article.
      ajax_command_invoke(NULL, 'highlightNews', array($id)),
    ),
  );
}
							</code></pre>
						</p>
					</section>
					<section>
						<p>Use ajax_render().<br />
						<pre style="font-size:40%;"><code class="php" data-trim>/**
 * Custom AJAX callback.
 */
function my_module_ajax_callback($id) {
  // Get news article based on id.
  $article = my_module_get_news_article($id);
  // Build array of AJAX commands.
  $commands = array();
  // Insert news article.
  $commands[] = ajax_command_insert('#news', drupal_render($article));
  // Add news article to news list.
  $commands[] = ajax_command_append('#news-list', '&lt;li>' . $article->title . '&lt;/li>');
  // Restripe news lists.
  $commands[] = ajax_command_restripe('#news-list');
  // Invoke JS function to highlight new article.
  $commands[] = ajax_command_invoke(NULL, 'highlightNews', array($id));
  //Return rendered commands.
  return ajax_render($commands);
}
							</code></pre>
						</p>
					</section>
				</section>
				<section>
					<h2>Drupal 8 Friendly</h2>
					<section>
						<ul>
							<li class="fragment">Part of the CommandInterface</li>
							<li class="fragment">Returned using an AJAX response object</li>
							<li class="fragment">Even more commands!</li>
							<li class="fragment">
								<a href="http://bit.ly/D8ajaxCMD" target="_blank">http://bit.ly/D8ajaxCMD</a>
							</li>
						</ul>
					</section>
					<section>
						<pre style="font-size:40%;"><code class="php" data-trim>/**
 * Custom AJAX callback. (D8)
 */
function my_module_ajax_callback($id) {
  // Get news article based on id.
  $article = my_module_get_news_article($id);
  // Build an AJAX response.
  $response = new AjaxResponse();
  // Insert news article.
  $response->addCommand( new InsertCommand('#news', drupal_render($article)));
  // Add news article to news list.
  $response->addCommand( new AppendCommand('#news-list', '&lt;li>' . $article->title . '&lt;/li>'));
  // Restripe news lists.
  $response->addCommand( new RestripeCommand('#news-list'));
  // Invoke JS function to highlight new article.
  $response->addCommand( new InvokeCommand(NULL, 'highlightNews', array($id)));
  //Return ajax response.
  return $response;
}
							</code></pre>
					</section>
				</section>
				<section>
					<section>
						<h1>Let's get real.</h1>
					</section>
					<section>
						<h2>The context.</h2>
						<ul>
							<li class="fragment">Client needed Quizzes</li>
							<li class="fragment">Quizzes need to submit via AJAX.</li>
							<li class="fragment">Using the
								<a href="https://www.drupal.org/project/quiz" target="_blank">Quiz Module</a>.
							</li>
						</ul>
					</section>
					<section>
						<h2>The Problem</h2>
						<img data-src="images/example_quiz.png" style="max-height:350px" />
						<ul>
							<li class="fragment">AJAX Quiz module does not work.</li>
							<li class="fragment">Need to update Form.</li>
							<li class="fragment">Need to update progress bar. (not part of form)</li>
						</ul>
					</section>
					<section>
						<h2>The Solution</h2>
						<ul>
							<li class="fragment">Use ajax commands in form submit callback.</li>
							<li class="fragment">Patch the Quiz module.</li>
							<li class="fragment">Patch the AJAX Quiz module.</li>
							<li class="fragment">Patch:
								<a href="https://www.drupal.org/node/2464087" target="_blank">drupal.org/node/2464087</a>
								<em style="font-size:70%;color:#999;">(reviewers needed)</em>
							</li>
						</ul>
					</section>
					<section>
						<p>Add AJAX to Quiz form submit buttons.<br />
						<pre style="font-size:40%;"><code class="php" data-trim>/**
 * Implements hook_form_alter().
 */
function ajax_quiz_form_alter(&$form, &$form_state, $form_id) {
  $quiz_forms = array(
    'quiz_question_answering_form',
    'quiz_report_form',
  );

  if (in_array($form_id, $quiz_forms) && user_access('access ajax quiz')) {
    // Wrap form.
    $form['#prefix'] = '&lt;div id="ajax-quiz-wrapper">';
    $form['#suffix'] = '&lt;/div>';

    // Add ajax to each submit button.
    $nav_children = element_children($form['navigation']);
    foreach ($nav_children as $nav_child) {
      if ($form['navigation'][$nav_child]['#type'] == 'submit') {
        $form['navigation'][$nav_child]['#ajax']['callback'] = 'ajax_quiz_navigate_quiz';
      }
    }
  }
}
						</code></pre>
					</p>
					</section>
					<section>
						<p>AJAX callback to render form and progress bar.<br />
						<pre style="font-size:40%;"><code class="php" data-trim>/**
 * AJAX callback for quiz submission.
 */
function ajax_quiz_navigate_quiz($form, &$form_state) {
  // Array for ajax commands to return.
  $commands = array();
  // ... Logic for gettings quiz, question and updating form.
  // Update progress counter.
  $progress['#markup'] = theme('quiz_progress', array(
    'questions' => $questions,
    'current' => $question_number,
    'allow_jumping' => $quiz->allow_jumping,
    'pager' => count($questions) >= variable_get('quiz_pager_start', 100),
    'time_limit' => $quiz->time_limit,
  ));
  $commands[] = ajax_command_replace("#quiz-progress", drupal_render($progress));
  // Rebuild for next question.
  // ... prep form-state for rebuild.
  $form = drupal_rebuild_form($form['#form_id'], $form_state, $form);
  $commands[] = ajax_command_replace("#ajax-quiz-wrapper", drupal_render($form));
  // Return ajax commands.
  return array('#type' => 'ajax', '#commands' => $commands);
}
						</code></pre>
						</p>
					</section>
					<section>
						<img data-src="images/example_quiz_submit.gif" />
					</section>
				</section>
				<section>
					<h2>Thank You!</h2>
					<p><a href="http://www.mike-miles.com/sessions/ajax-commands" target="_blank">mike-miles.com/sessions/ajax-commands</a>
					</p>
					<p>
						<small><a href="http://mike-miles.com" target="_blank">Mike Miles</a> / <a href="http://twitter.com/mikemiles86" target="_blank">@mikemiles86</a></small>
					</p>
				</section>
			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
